<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Sensodyne Ramadan Riddles</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* --- FONT FACE --- */
    @font-face {
        font-family: 'Gilroy';
        src: url('assets/Gilroy-ExtraBold.ttf') format('opentype'),
             url('assets/Gilroy-Light.ttf') format('opentype');
        font-weight: normal;
        font-style: normal;
    }

    /* --- CONFIGURATION --- */
    :root {
        --primary: #0070c0;   
        --dark-blue: #003366; 
        --accent: #00d2ff;    
        --text-color: #ffffff;
        
        /* ASSETS */
        --bg-image: url('assets/background.png'); 
        --logo-image: url('assets/Sensodyne Ramadan Logo.png'); 
        --header-pattern: url('assets/top pattern.png'); 
        --pdf-icon-img: url('assets/pdf_icon.png');
        --tip-icon-img: url('assets/tip_icon.png');
        --star-icon: url('assets/star_icon.png'); 
        --done-icon: url('assets/done_icon.png'); 
    }

    /* --- GLOBAL STYLES --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'Gilroy', 'Segoe UI', Tahoma, sans-serif;
        background: var(--dark-blue) var(--bg-image) no-repeat center center fixed;
        background-size: cover;
        margin: 0; padding: 0;
        color: var(--text-color);
        height: 100dvh;
        width: 100vw;
        overflow: hidden;
        display: flex;
        justify-content: center;
        overscroll-behavior: none; 
        user-select: none; 
    }

    .app-container {
        width: 100%; max-width: 450px;
        height: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .app-container::-webkit-scrollbar { display: none; }

    .screen {
        display: none;
        flex-direction: column;
        align-items: center;
        width: 100%;
        min-height: 100%;
        padding: 20px;
        animation: fadeIn 0.4s ease-in-out;
    }
    .screen.active { display: flex; }

    /* --- UI ELEMENTS --- */
    .logo {
        width: 180px; height: 80px;
        background: var(--logo-image) no-repeat center;
        background-size: contain;
        margin: 40px 0; flex-shrink: 0;
    }

    .input-group { width: 85%; margin-bottom: 15px; }
    
    input {
        width: 100%;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.6);
        border-radius: 12px;
        padding: 14px 15px;
        color: white;
        font-family: 'Gilroy', sans-serif;
        font-size: 16px;
        outline: none; text-align: center;
        transition: 0.3s;
        appearance: none; 
    }
    input:focus { border-color: #fff; background: rgba(255,255,255,0.2); }

    .btn {
        width: 85%; padding: 8px;
        background: linear-gradient(180deg, #0099cc 0%, #0056b3 100%);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 20px 0 20px 0;
        color: white; font-family: 'Gilroy', sans-serif;
        font-size: 18px; font-weight: bold; cursor: pointer;
        margin-top: 10px; transition: all 0.2s;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .btn:active { transform: scale(0.98); }
    .btn-secondary { background: transparent; border: 1px solid rgba(255,255,255,0.5); margin-top: 10px; }

    /* --- HEADER --- */
    .header-banner {
        width: 100%; height: 100px; 
        background: linear-gradient(180deg, #0056b3 0%, #0070c0 100%);
        border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        position: relative; margin-bottom: 20px; flex-shrink: 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); overflow: visible; z-index: 10;
    }
    .header-pattern {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background-image: var(--header-pattern);
        background-repeat: repeat; background-position: center; background-size: cover; 
        opacity: 0.5;
        border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        z-index: 1; pointer-events: none;
    }
    .header-content {
        position: relative; z-index: 2;
        display: flex; justify-content: space-between; align-items: center;
        height: 100%; padding: 0 25px; padding-top: 5px;
    }
    .user-info { flex: 1; text-align: left; }
    .logo-center {
        width: 80px; height: 50px;
        background: var(--logo-image) no-repeat center;
        background-size: contain; flex: 0 0 80px;
    }
    .score-container { flex: 1; display: flex; justify-content: flex-end; position: relative; }
    .score-pill {
        background: rgba(0, 153, 204, 0.9);
        border: 1px solid rgba(255,255,255,0.5);
        border-radius: 20px; padding: 6px 14px;
        display: flex; align-items: center; gap: 6px;
        font-weight: bold; cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* --- LEVEL GRID --- */
    .level-grid {
        display: grid; grid-template-columns: repeat(4, 1fr);
        gap: 12px; width: 100%; padding: 0 35px 35px 35px; 
    }
    .level-btn {
        aspect-ratio: 1;
        background: linear-gradient(135deg, #0070c0, #0056b3);
        border-radius: 20px;
        display: flex; justify-content: center; align-items: center;
        font-size: 20px; font-weight: bold; color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .level-btn.locked { opacity: 0.6; box-shadow: none; }
    .level-btn.completed { background: white; border: 2px solid #FFD700; }
    .star-img { width: 70%; height: 70%; background: var(--star-icon) no-repeat center; background-size: contain; }

    /* --- PUZZLE GAME (1080x1080 SIMULATION) --- */
    .puzzle-board-container {
        width: 100%;
        max-width: 340px;
        margin: 20px auto;
        /* Force 1:1 Aspect Ratio to simulate 1080x1080 */
        aspect-ratio: 1 / 1; 
        position: relative;
        background: rgba(255,255,255,0.05);
        border: 2px dashed rgba(255,255,255,0.3); border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }
    
    /* Drop Zones (Invisible Quadrants) */
    .drop-zone { position: absolute; width: 50%; height: 50%; z-index: 5; }
    .dz-1 { top: 0; left: 0; } .dz-2 { top: 0; right: 0; }
    .dz-3 { bottom: 0; left: 0; } .dz-4 { bottom: 0; right: 0; }

    /* PUZZLE PIECE SIZING 
       Based on 1080px Canvas:
       - 698px = ~64.63%
       - 546px = ~50.56%
    */
    .puzzle-piece-placed {
        position: absolute;
        object-fit: fill; /* Ensure image fills the calculated area */
        pointer-events: none; 
        z-index: 10;
        filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
    }
    
    /* 1.png: 698x546 -> Top Left */
    .piece-1-pos { width: 64.63%; height: 50.56%; top: 0; left: 0; z-index: 12; }
    
    /* 2.png: 546x698 -> Top Right */
    .piece-2-pos { width: 50.56%; height: 64.63%; top: 0; right: 0; z-index: 11; }
    
    /* 3.png: 546x698 -> Bottom Left */
    .piece-3-pos { width: 50.56%; height: 64.63%; bottom: 0; left: 0; z-index: 11; }
    
    /* 4.png: 698x546 -> Bottom Right */
    .piece-4-pos { width: 64.63%; height: 50.56%; bottom: 0; right: 0; z-index: 12; }

    /* Tray */
    .puzzle-tray {
        display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 15px; padding: 10px;
        width: 100%; min-height: 90px; background: rgba(0,0,0,0.2); border-radius: 15px;
        justify-content: flex-start; scrollbar-width: none;
    }
    .puzzle-piece-thumb { 
        width: 80px; height: 80px; flex-shrink: 0; cursor: grab;
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); touch-action: none;
        background: rgba(255,255,255,0.1); border-radius: 5px; padding: 5px;
    }
    .puzzle-piece-thumb img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

    /* --- MEMORY GAME --- */
    .memory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 20px 0; width: 100%; }
    .memory-card { 
        background: #0070c0; aspect-ratio: 1; border-radius: 8px; 
        cursor: pointer; display:flex; justify-content:center; align-items:center; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .memory-card.flipped { background: white; border: 2px solid #0070c0; }
    .memory-card img { width: 80%; height: 80%; object-fit: contain; display: none; }
    .memory-card.flipped img { display: block; }

    /* --- OTHER STYLES --- */
    .content-card {
        background: rgba(255,255,255,0.95); border-radius: 24px; padding: 25px; width: 90%;
        text-align: center; color: #333; margin-top: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .media-custom-icon { width: 100px; height: 100px; object-fit: contain; margin-bottom: 10px; }
    .badge-top {
        background: linear-gradient(90deg, #003366, #0070c0); color: white; padding: 8px 25px; 
        border-radius: 20px; display: inline-block; margin-bottom: 20px; font-weight: bold; font-size: 14px;
    }
    .quiz-opt {
        background: white; border: none; color: #0070c0; 
        padding: 16px; border-radius: 20px 0 20px 0; width: 100%; margin-bottom: 12px;
        font-size: 16px; font-weight: bold; cursor: pointer;
        text-align: center; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .quiz-opt:active, .quiz-opt.selected { background: #0070c0; color: white; transform: scale(0.98); }
    .quiz-question-box {
        background: linear-gradient(135deg, #002244, #0056b3); padding: 25px; border-radius: 16px; 
        margin-bottom: 25px; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .done-card {
        border: 1px solid rgba(255,255,255,0.5); border-radius: 20px; padding: 40px 30px; width: 85%;
        text-align: center; background: transparent; box-shadow: none;
    }
    .done-icon-large {
        width: 120px; height: 120px; background: var(--done-icon) no-repeat center; 
        background-size: contain; margin: 0 auto 20px auto;
    }
    .done-text { font-size: 32px; font-weight: 800; color: white; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
    .done-score { font-size: 18px; color: #ddd; margin-top: 5px; margin-bottom: 30px; }
    
    .rewards-menu {
        position: absolute; top: 120%; right: 0;
        background: #004a99; border: 1px solid #00d2ff;
        border-radius: 12px; padding: 15px; width: 180px;
        z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        opacity: 0; visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .rewards-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .reward-item { font-size: 13px; margin: 10px 0; opacity: 0.6; color: white; display:flex; gap:8px; align-items:center; }
    .reward-item.unlocked { opacity: 1; font-weight: bold; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.5); }
    
    .dialog-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: none;
        justify-content: center; align-items: center; z-index: 999;
        backdrop-filter: blur(5px);
    }
    .dialog-box {
        background: linear-gradient(135deg, #0070c0, #004a99);
        width: 85%; padding: 30px; border-radius: 24px;
        text-align: center; border: 1px solid rgba(255,255,255,0.3);
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="app-container">
    
    <div id="login-screen" class="screen active" style="justify-content: center;">
        <div class="logo"></div>
        <div class="input-group"><input type="email" id="login-email" placeholder="Email Address"></div>
        <button class="btn" onclick="handleLogin(this)">Start Playing</button>
    </div>

    <div id="register-screen" class="screen" style="justify-content: center;">
        <h2 style="margin-bottom:30px;">New Player</h2>
        <div class="input-group"><input type="text" id="reg-name" placeholder="Full Name"></div>
        <div class="input-group"><input type="tel" id="reg-phone" placeholder="Phone Number"></div>
        <div class="input-group"><input type="email" id="reg-email" placeholder="Email Address" readonly></div>
        <button class="btn" onclick="handleRegister(this)">Create & Play</button>
        <button class="btn btn-secondary" onclick="showScreen('login-screen')">Cancel</button>
    </div>

    <div id="home-screen" class="screen" onclick="closeRewards()" style="padding:0;">
        <div class="header-banner">
            <div class="header-pattern"></div>
            <div class="header-content">
                <div class="user-info">
                    <div style="font-size:14px; opacity:0.8; margin-bottom:2px;">Hello!</div>
                    <div id="display-name" style="font-size:20px; font-weight:bold; line-height:1.1;">Player</div>
                </div>
                <div class="logo-center"></div>
                <div class="score-container">
                    <div class="score-pill" onclick="toggleRewards(event)">
                        <span>‚≠ê</span> <span id="display-score">0</span>
                    </div>
                    <div id="rewards-menu" class="rewards-menu">
                        <div style="font-size:12px; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">REWARDS</div>
                        <div class="reward-item" id="rwd-1"><span>üß¢</span> 10-50 pts</div>
                        <div class="reward-item" id="rwd-2"><span>üß¥</span> 50-100 pts</div>
                        <div class="reward-item" id="rwd-3"><span>üéπ</span> 100+ pts</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="level-grid" id="level-grid"></div>
        <button class="btn btn-secondary" style="width:60%; margin-top:10px; margin-bottom:40px;" onclick="location.reload()">Log Out</button>
    </div>

    <div id="media-screen" class="screen" style="justify-content:center;">
        <div class="logo" style="transform:scale(0.8); margin-top:0; margin-bottom:10px;"></div>
        <div class="badge-top" id="media-lvl-badge">Level 1</div>
        <div class="content-card">
            <div id="media-icon-container" style="margin-bottom:10px; display:flex; justify-content:center;"></div>
            <div id="media-container"></div>
            <div id="media-text" style="font-weight:bold; color:#0070c0; margin-top:10px;">Click to Open</div>
        </div>
        <button id="media-wait-btn" class="btn" style="margin-top:30px;" disabled>Please Wait...</button>
        <button class="btn btn-secondary" onclick="showScreen('home-screen')">Back</button>
    </div>

    <div id="minigame-screen" class="screen">
        <div class="logo" style="transform:scale(0.7); margin:10px 0;"></div>
        <h2 id="mini-title" style="margin: 10px 0;">Game Time</h2>
        <p style="font-size:14px; opacity:0.8; margin-top:0;">Complete to unlock the question!</p>
        
        <div id="memory-board" class="memory-grid" style="display:none"></div>
        
        <div id="puzzle-board" style="display:none; width:100%; max-width:320px;">
            <div class="puzzle-board-container">
                <div class="puzzle-grid" id="puzzle-slots">
                    <div class="drop-zone dz-1" data-s="1"></div>
                    <div class="drop-zone dz-2" data-s="2"></div>
                    <div class="drop-zone dz-3" data-s="3"></div>
                    <div class="drop-zone dz-4" data-s="4"></div>
                </div>
            </div>
            <div id="p-pieces" class="puzzle-tray"></div>
        </div>

        <button id="mini-next-btn" class="btn" onclick="finishMiniGame(this)" disabled style="margin-top: auto; margin-bottom: 20px;">Next</button>
    </div>

    <div id="quiz-screen" class="screen" style="justify-content:center;">
        <div class="logo" style="transform:scale(0.7); margin-bottom:20px; margin-top:0;"></div>
        <div class="quiz-question-box">
            <h3 id="q-text" style="margin:0; text-align:center; font-weight:600; font-size: 18px;">Question?</h3>
        </div>
        <div id="q-options" style="width:100%;"></div>
    </div>

    <div id="done-screen" class="screen" style="justify-content:center;">
        <div class="logo" style="margin-bottom:40px;"></div>
        <div class="done-card">
            <div class="done-icon-large"></div>
            <h1 class="done-text">DONE</h1>
            <p class="done-score">Score: <span id="final-score" style="font-weight:bold; color:white;">10</span></p>
            <button class="btn" style="width:100%;" onclick="showScreen('home-screen')">OK</button>
        </div>
    </div>
</div>

<div id="level-score-dialog" class="dialog-overlay" onclick="this.style.display='none'">
    <div class="dialog-box" onclick="event.stopPropagation()">
        <h2 style="margin-top:0; color:white;">Level Completed</h2>
        <div style="font-size:60px; margin:15px 0;">‚≠ê</div>
        <p style="font-size:18px; color:white;">You earned <b id="dialog-lvl-pts" style="color:#FFD700; font-size:24px;">0</b> points</p>
        <button class="btn" onclick="document.getElementById('level-score-dialog').style.display='none'">Close</button>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzIXt0QvCjg3iYDx4zL5gVODVeFBXW2jd12TFJzMKMWxL7iH4BD6Com16YxSRkvuHir/exec'; 
    let currentUser = null;
    let levelsMap = new Map();
    let currentLevelId = 0;

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function toggleBtnLoading(btn, isLoading) { if(isLoading) { btn.dataset.ogText = btn.innerText; btn.innerText = "Loading..."; btn.classList.add('loading'); btn.disabled = true; } else { if(btn.dataset.ogText) btn.innerText = btn.dataset.ogText; btn.classList.remove('loading'); btn.disabled = false; } }
    
    function handleLogin(btn) {
        const email = document.getElementById('login-email').value;
        if(!email) return alert("Please enter email");
        toggleBtnLoading(btn, true);
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'login', email }) }).then(r=>r.json()).then(d=>{ toggleBtnLoading(btn,false); if(d.status==='success') loadUserData(d); else if(d.message.includes('not found')) { document.getElementById('reg-email').value = email; showScreen('register-screen'); } else alert(d.message); });
    }
    function handleRegister(btn) {
        const name = document.getElementById('reg-name').value;
        const phone = document.getElementById('reg-phone').value;
        const email = document.getElementById('reg-email').value;
        toggleBtnLoading(btn, true);
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'register', name, phone, email }) }).then(r=>r.json()).then(d=>{ toggleBtnLoading(btn,false); if(d.status==='success') loadUserData(d); });
    }
    function loadUserData(data) { currentUser = data.user; levelsMap.clear(); data.gameConfig.forEach(l => levelsMap.set(l.id, l)); renderHome(); showScreen('home-screen'); }
    function renderHome() {
        document.getElementById('display-name').innerText = currentUser.name;
        document.getElementById('display-score').innerText = currentUser.totalScore;
        const grid = document.getElementById('level-grid'); grid.innerHTML = '';
        levelsMap.forEach((cfg, id) => {
            const userLvl = currentUser.levels[id];
            const div = document.createElement('div');
            if(userLvl && userLvl.status === 'completed') { div.className = 'level-btn completed'; div.innerHTML = '<div class="star-img"></div>'; div.onclick = () => showLevelScore(id, userLvl.score); }
            else if (cfg.isActive) { div.className = 'level-btn'; div.innerText = id; div.onclick = () => startLevelFlow(id); }
            else { div.className = 'level-btn locked'; div.innerText = id; }
            grid.appendChild(div);
        });
        updateRewardsMenu(currentUser.totalScore);
    }
    function showLevelScore(id, score) { document.getElementById('dialog-lvl-pts').innerText = score; document.getElementById('level-score-dialog').style.display = 'flex'; }
    function toggleRewards(e) { e.stopPropagation(); document.getElementById('rewards-menu').classList.toggle('show'); }
    function closeRewards() { document.getElementById('rewards-menu').classList.remove('show'); }
    function updateRewardsMenu(score) { if(score>=10) document.getElementById('rwd-1').classList.add('unlocked'); if(score>=50) document.getElementById('rwd-2').classList.add('unlocked'); if(score>=100) document.getElementById('rwd-3').classList.add('unlocked'); }

    /* --- SMART MEDIA LOADER (Updated for Redirect) --- */
    function startLevelFlow(id) {
        currentLevelId = id; 
        const cfg = levelsMap.get(id);
        document.getElementById('media-lvl-badge').innerText = `Level ${id}`;
        const iconCon = document.getElementById('media-icon-container'), mediaCon = document.getElementById('media-container'), waitBtn = document.getElementById('media-wait-btn'), txt = document.getElementById('media-text');
        iconCon.innerHTML = ''; mediaCon.innerHTML = ''; waitBtn.innerText = "Please Wait..."; waitBtn.classList.remove('loading'); waitBtn.disabled = true;
        
        const link = cfg.mediaContent || "";

        if(cfg.mediaType === 'tip') { 
            iconCon.innerHTML = `<img src="assets/tip_icon.png" class="media-custom-icon">`; 
            mediaCon.innerHTML = `<p style="font-size:18px; padding:10px;">${cfg.mediaContent}</p>`; 
            txt.innerText = "Read the Tip"; 
        } 
        else if (cfg.mediaType === 'pdf') { 
            iconCon.innerHTML = `<img src="assets/pdf_icon.png" class="media-custom-icon">`; 
            txt.innerHTML = `<a href="${link}" target="_blank" class="btn" style="text-decoration:none; display:inline-block; margin-top:5px;">üìÑ Open PDF</a>`; 
        } 
        else if (cfg.mediaType === 'video') { 
            iconCon.innerHTML = '<i class="fas fa-video" style="font-size:60px; color:#0070c0; margin-bottom:10px;"></i>';
            mediaCon.innerHTML = '';
            txt.innerHTML = `<a href="${link}" target="_blank" class="btn" style="text-decoration:none; display:inline-block; margin-top:5px;">üé• Watch Video</a>`;
        } 
        else if (cfg.mediaType === 'audio') { 
            iconCon.innerHTML = '<i class="fas fa-headphones" style="font-size:60px; color:#0070c0; margin-bottom:10px;"></i>';
            mediaCon.innerHTML = '';
            txt.innerHTML = `<a href="${link}" target="_blank" class="btn" style="text-decoration:none; display:inline-block; margin-top:5px;">üéß Listen to Audio</a>`;
        } 
        else { 
            iconCon.innerHTML = '<i class="fas fa-gamepad" style="font-size:60px; color:#0070c0;"></i>'; 
            txt.innerText = "Get Ready"; 
        }

        showScreen('media-screen');
        setTimeout(() => { waitBtn.innerText = "Start Game"; waitBtn.disabled = false; waitBtn.onclick = () => enterMiniGame(); }, 3000);
    }

    function enterMiniGame() {
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateScore', email: currentUser.email, levelId: currentLevelId, stage: 'start' }) });
        currentUser.totalScore += 3;
        const cfg = levelsMap.get(currentLevelId);
        const gameType = cfg.gameType || 'memory';
        document.getElementById('memory-board').style.display = 'none'; document.getElementById('puzzle-board').style.display = 'none'; document.getElementById('mini-next-btn').disabled = true;
        if(gameType === 'puzzle') setupPuzzle(); else setupMemory();
        showScreen('minigame-screen');
    }

    function setupMemory() {
        const board = document.getElementById('memory-board');
        board.style.display = 'grid'; board.innerHTML = '';
        let matches = 0; let flipped = [];
        const assets = ['tube.png', 'molar.png', 'broken-tooth.png', 'tooth.png'];
        const cards = [...assets, ...assets].sort(() => Math.random() - 0.5);

        cards.forEach((filename) => {
            const card = document.createElement('div');
            card.className = 'memory-card'; 
            card.innerHTML = `<img src="assets/${filename}" alt="Icon">`;
            card.onclick = () => {
                if(flipped.length < 2 && !card.classList.contains('flipped')) {
                    card.classList.add('flipped'); flipped.push({card, val: filename});
                    if(flipped.length === 2) {
                        if(flipped[0].val === flipped[1].val) {
                            matches++; flipped = [];
                            if(matches === 4) document.getElementById('mini-next-btn').disabled = false;
                        } else {
                            setTimeout(() => { flipped.forEach(f => { f.card.classList.remove('flipped'); }); flipped = []; }, 800);
                        }
                    }
                }
            };
            board.appendChild(card);
        });
    }

    let draggedPiece = null;
    let touchOffsetX = 0;
    let touchOffsetY = 0;

    function setupPuzzle() {
        const board = document.getElementById('puzzle-board');
        board.style.display = 'block';
        const container = document.getElementById('p-pieces'); container.innerHTML = '';
        
        document.querySelectorAll('.drop-zone').forEach(dz => {
            dz.innerHTML = '';
            dz.ondragover = e => e.preventDefault();
            dz.ondrop = e => handleDrop(e, dz);
        });
        
        const pieces = [1, 2, 3, 4];
        pieces.sort(()=>Math.random()-.5).forEach(i => {
            const p = document.createElement('div');
            p.className = 'puzzle-piece-thumb';
            p.innerHTML = `<img src="assets/${i}.png" draggable="false">`; 
            p.dataset.id = i;
            p.draggable = true;
            p.ondragstart = (e) => e.dataTransfer.setData('text', i);
            p.addEventListener('touchstart', handleTouchStart, {passive: false});
            p.addEventListener('touchmove', handleTouchMove, {passive: false});
            p.addEventListener('touchend', handleTouchEnd);
            container.appendChild(p);
        });
    }

    function handleTouchStart(e) {
        e.preventDefault();
        draggedPiece = e.target.closest('.puzzle-piece-thumb');
        if(!draggedPiece) return;
        const touch = e.touches[0];
        const rect = draggedPiece.getBoundingClientRect();
        touchOffsetX = touch.clientX - rect.left;
        touchOffsetY = touch.clientY - rect.top;
        draggedPiece.style.position = 'fixed'; draggedPiece.style.zIndex = 1000;
        document.body.append(draggedPiece); 
        moveAt(touch.clientX, touch.clientY);
    }
    function handleTouchMove(e) { e.preventDefault(); if (!draggedPiece) return; moveAt(e.touches[0].clientX, e.touches[0].clientY); }
    function moveAt(x, y) { if(draggedPiece) { draggedPiece.style.left = x - touchOffsetX + 'px'; draggedPiece.style.top = y - touchOffsetY + 'px'; } }
    function handleTouchEnd(e) {
        if (!draggedPiece) return;
        draggedPiece.style.display = 'none'; 
        let elemBelow = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        draggedPiece.style.display = 'flex'; 
        let slot = elemBelow ? elemBelow.closest('.drop-zone') : null;
        const id = draggedPiece.dataset.id;
        if (slot && slot.dataset.s == id) {
            slot.innerHTML = `<img src="assets/${id}.png" class="puzzle-piece-placed piece-${id}-pos">`;
            draggedPiece.remove(); checkPuzzleWin();
        } else {
            draggedPiece.style.position = 'static'; draggedPiece.style.zIndex = 'auto';
            document.getElementById('p-pieces').appendChild(draggedPiece);
        }
        draggedPiece = null;
    }

    function handleDrop(e, dz) { 
        const id = e.dataTransfer.getData('text');
        if(dz.dataset.s == id) { 
            dz.innerHTML = `<img src="assets/${id}.png" class="puzzle-piece-placed piece-${id}-pos">`;
            const originals = document.querySelectorAll('.puzzle-piece-thumb');
            originals.forEach(p => { if(p.dataset.id == id) p.remove(); });
            checkPuzzleWin(); 
        } 
    }
    function checkPuzzleWin() { if(Array.from(document.querySelectorAll('.drop-zone')).every(s => s.hasChildNodes())) document.getElementById('mini-next-btn').disabled = false; }

    function finishMiniGame(btn) {
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        toggleBtnLoading(btn, true);
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateScore', email: currentUser.email, levelId: currentLevelId, stage: 'minigame' }) })
        .then(() => {
            toggleBtnLoading(btn, false);
            currentUser.totalScore += 4;
            startQuiz();
        });
    }

    function startQuiz() {
        const cfg = levelsMap.get(currentLevelId);
        document.getElementById('q-text').innerText = cfg.question;
        const optCon = document.getElementById('q-options'); optCon.innerHTML = '';
        cfg.options.forEach((opt, idx) => {
            const btn = document.createElement('div'); btn.className = 'quiz-opt'; btn.innerText = opt;
            btn.onclick = function() { document.querySelectorAll('.quiz-opt').forEach(b => b.classList.remove('selected')); this.classList.add('selected'); submitAnswer(idx + 1); };
            optCon.appendChild(btn);
        });
        showScreen('quiz-screen');
    }

    function submitAnswer(selectedIdx) {
        document.querySelectorAll('.quiz-opt').forEach(o => o.style.pointerEvents = 'none');
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateScore', email: currentUser.email, levelId: currentLevelId, stage: 'finish', selectedOption: selectedIdx }) })
        .then(r => r.json()).then(d => {
            currentUser.totalScore = d.totalScore; currentUser.levels = d.levels;
            const pts = d.isCorrect ? 10 : 7;
            document.getElementById('final-score').innerText = pts;
            if(d.isCorrect) confetti();
            showScreen('done-screen');
            renderHome();
        });
    }
</script>
</body>
</html>