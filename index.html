<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Sensodyne Ramadan Riddles</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="app-container">
    
    <div id="login-screen" class="screen active" style="justify-content: center;">
        <div class="logo"></div>
        <div class="input-group"><input type="email" id="login-email" placeholder="Email Address"></div>
        <button class="btn" onclick="handleLogin(this)">Start Playing</button>
    </div>

    <div id="register-screen" class="screen" style="justify-content: center;">
        <h2 style="margin-bottom:30px;">New Player</h2>
        <div class="input-group"><input type="text" id="reg-name" placeholder="Full Name"></div>
        <div class="input-group"><input type="tel" id="reg-phone" placeholder="Phone Number"></div>
        <div class="input-group"><input type="email" id="reg-email" placeholder="Email Address" readonly></div>
        <button class="btn" onclick="handleRegister(this)">Create & Play</button>
        <button class="btn btn-secondary" onclick="showScreen('login-screen')">Cancel</button>
    </div>

    <div id="home-screen" class="screen" onclick="closeRewards()" style="padding:0;">
        <div class="header-banner">
            <div class="header-pattern"></div>
            <div class="header-content">
                <div class="user-info">
                    <div style="font-size:14px; opacity:0.8; margin-bottom:2px;">Hello!</div>
                    <div id="display-name" style="font-size:20px; font-weight:bold; line-height:1.1;">Player</div>
                </div>
                <div class="logo-center"></div>
                <div class="score-container">
                    <div class="score-pill" onclick="toggleRewards(event)">
                        <span>‚≠ê</span> <span id="display-score">0</span>
                    </div>
                    <div id="rewards-menu" class="rewards-menu">
                        <div style="font-size:12px; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">REWARDS</div>
                        <div class="reward-item" id="rwd-1"><span>üß¢</span> 10-50 pts</div>
                        <div class="reward-item" id="rwd-2"><span>üß¥</span> 50-100 pts</div>
                        <div class="reward-item" id="rwd-3"><span>üéπ</span> 100+ pts</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="level-grid" id="level-grid"></div>
        <button class="btn btn-secondary" style="width:60%; margin-top:10px; margin-bottom:40px;" onclick="location.reload()">Log Out</button>
    </div>

    <div id="media-screen" class="screen" style="justify-content:center;">
        <div class="logo" style="transform:scale(0.8); margin-top:0; margin-bottom:10px;"></div>
        <div class="badge-top" id="media-lvl-badge">Level 1</div>
        <div class="content-card">
            <div id="media-icon-container" style="margin-bottom:10px; display:flex; justify-content:center;"></div>
            <div id="media-container"></div>
            <div id="media-text" style="font-weight:bold; color:#0070c0; margin-top:10px;">Click to Open</div>
        </div>
        <button id="media-wait-btn" class="btn" style="margin-top:30px;" disabled>Please Wait...</button>
        <button class="btn btn-secondary" onclick="showScreen('home-screen')">Back</button>
    </div>

    <div id="minigame-screen" class="screen">
        <div class="logo" style="transform:scale(0.7); margin:10px 0;"></div>
        <h2 id="mini-title" style="margin: 10px 0;">Game Time</h2>
        <p style="font-size:14px; opacity:0.8; margin-top:0;">Complete to unlock the question!</p>
        
        <div id="memory-board" class="memory-grid" style="display:none"></div>
        
        <div id="puzzle-board" style="display:none; width:100%; max-width:320px;">
            <div class="puzzle-board-container">
                <div class="puzzle-grid" id="puzzle-slots">
                    <div class="drop-zone dz-1" data-s="1"></div>
                    <div class="drop-zone dz-2" data-s="2"></div>
                    <div class="drop-zone dz-3" data-s="3"></div>
                    <div class="drop-zone dz-4" data-s="4"></div>
                </div>
            </div>
            <div id="p-pieces" class="puzzle-tray"></div>
        </div>

        <button id="mini-next-btn" class="btn" onclick="finishMiniGame(this)" disabled style="margin-top: auto; margin-bottom: 20px;">Next</button>
    </div>

    <div id="quiz-screen" class="screen" style="justify-content:center;">
        <div class="logo" style="transform:scale(0.7); margin-bottom:20px; margin-top:0;"></div>
        <div class="quiz-question-box">
            <h3 id="q-text" style="margin:0; text-align:center; font-weight:600; font-size: 18px;">Question?</h3>
        </div>
        <div id="q-options" style="width:100%;"></div>
    </div>

    <div id="done-screen" class="screen" style="justify-content:center;">
        <div class="logo" style="margin-bottom:40px;"></div>
        <div class="done-card">
            <div class="done-icon-large"></div>
            <h1 class="done-text">DONE</h1>
            <p class="done-score">Score: <span id="final-score" style="font-weight:bold; color:white;">10</span></p>
            <button class="btn" style="width:100%;" onclick="showScreen('home-screen')">OK</button>
        </div>
    </div>
</div>

<div id="level-score-dialog" class="dialog-overlay" onclick="this.style.display='none'">
    <div class="dialog-box" onclick="event.stopPropagation()">
        <h2 style="margin-top:0; color:white;">Level Completed</h2>
        <div style="font-size:60px; margin:15px 0;">‚≠ê</div>
        <p style="font-size:18px; color:white;">You earned <b id="dialog-lvl-pts" style="color:#FFD700; font-size:24px;">0</b> points</p>
        <button class="btn" onclick="document.getElementById('level-score-dialog').style.display='none'">Close</button>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzIXt0QvCjg3iYDx4zL5gVODVeFBXW2jd12TFJzMKMWxL7iH4BD6Com16YxSRkvuHir/exec'; 
    let currentUser = null;
    let levelsMap = new Map();
    let currentLevelId = 0;

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function toggleBtnLoading(btn, isLoading) { if(isLoading) { btn.dataset.ogText = btn.innerText; btn.innerText = "Loading..."; btn.classList.add('loading'); btn.disabled = true; } else { if(btn.dataset.ogText) btn.innerText = btn.dataset.ogText; btn.classList.remove('loading'); btn.disabled = false; } }
    
    function handleLogin(btn) {
        const email = document.getElementById('login-email').value;
        if(!email) return alert("Please enter email");
        toggleBtnLoading(btn, true);
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'login', email }) }).then(r=>r.json()).then(d=>{ toggleBtnLoading(btn,false); if(d.status==='success') loadUserData(d); else if(d.message.includes('not found')) { document.getElementById('reg-email').value = email; showScreen('register-screen'); } else alert(d.message); });
    }
    function handleRegister(btn) {
        const name = document.getElementById('reg-name').value;
        const phone = document.getElementById('reg-phone').value;
        const email = document.getElementById('reg-email').value;
        toggleBtnLoading(btn, true);
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'register', name, phone, email }) }).then(r=>r.json()).then(d=>{ toggleBtnLoading(btn,false); if(d.status==='success') loadUserData(d); });
    }
    function loadUserData(data) { currentUser = data.user; levelsMap.clear(); data.gameConfig.forEach(l => levelsMap.set(l.id, l)); renderHome(); showScreen('home-screen'); }
    function renderHome() {
        document.getElementById('display-name').innerText = currentUser.name;
        document.getElementById('display-score').innerText = currentUser.totalScore;
        const grid = document.getElementById('level-grid'); grid.innerHTML = '';
        levelsMap.forEach((cfg, id) => {
            const userLvl = currentUser.levels[id];
            const div = document.createElement('div');
            if(userLvl && userLvl.status === 'completed') { div.className = 'level-btn completed'; div.innerHTML = '<div class="star-img"></div>'; div.onclick = () => showLevelScore(id, userLvl.score); }
            else if (cfg.isActive) { div.className = 'level-btn'; div.innerText = id; div.onclick = () => startLevelFlow(id); }
            else { div.className = 'level-btn locked'; div.innerText = id; }
            grid.appendChild(div);
        });
        updateRewardsMenu(currentUser.totalScore);
    }
    function showLevelScore(id, score) { document.getElementById('dialog-lvl-pts').innerText = score; document.getElementById('level-score-dialog').style.display = 'flex'; }
    function toggleRewards(e) { e.stopPropagation(); document.getElementById('rewards-menu').classList.toggle('show'); }
    function closeRewards() { document.getElementById('rewards-menu').classList.remove('show'); }
    function updateRewardsMenu(score) { if(score>=10) document.getElementById('rwd-1').classList.add('unlocked'); if(score>=50) document.getElementById('rwd-2').classList.add('unlocked'); if(score>=100) document.getElementById('rwd-3').classList.add('unlocked'); }

    /* --- SMART MEDIA LOADER (Updated for Redirect) --- */
    function startLevelFlow(id) {
        currentLevelId = id; 
        const cfg = levelsMap.get(id);
        document.getElementById('media-lvl-badge').innerText = `Level ${id}`;
        const iconCon = document.getElementById('media-icon-container'), mediaCon = document.getElementById('media-container'), waitBtn = document.getElementById('media-wait-btn'), txt = document.getElementById('media-text');
        iconCon.innerHTML = ''; mediaCon.innerHTML = ''; waitBtn.innerText = "Please Wait..."; waitBtn.classList.remove('loading'); waitBtn.disabled = true;
        
        const link = cfg.mediaContent || "";

        if(cfg.mediaType === 'tip') { 
            iconCon.innerHTML = `<img src="assets/tip_icon.png" class="media-custom-icon">`; 
            mediaCon.innerHTML = `<p style="font-size:18px; padding:10px;">${cfg.mediaContent}</p>`; 
            txt.innerText = "Read the Tip"; 
        } 
        else if (cfg.mediaType === 'pdf') { 
            iconCon.innerHTML = `<img src="assets/pdf_icon.png" class="media-custom-icon">`; 
            txt.innerHTML = `<a href="${link}" target="_blank" class="btn" style="text-decoration:none; display:inline-block; margin-top:5px;">üìÑ Open PDF</a>`; 
        } 
        else if (cfg.mediaType === 'video') { 
            iconCon.innerHTML = '<i class="fas fa-video" style="font-size:60px; color:#0070c0; margin-bottom:10px;"></i>';
            mediaCon.innerHTML = '';
            txt.innerHTML = `<a href="${link}" target="_blank" class="btn" style="text-decoration:none; display:inline-block; margin-top:5px;">üé• Watch Video</a>`;
        } 
        else if (cfg.mediaType === 'audio') { 
            iconCon.innerHTML = '<i class="fas fa-headphones" style="font-size:60px; color:#0070c0; margin-bottom:10px;"></i>';
            mediaCon.innerHTML = '';
            txt.innerHTML = `<a href="${link}" target="_blank" class="btn" style="text-decoration:none; display:inline-block; margin-top:5px;">üéß Listen to Audio</a>`;
        } 
        else { 
            iconCon.innerHTML = '<i class="fas fa-gamepad" style="font-size:60px; color:#0070c0;"></i>'; 
            txt.innerText = "Get Ready"; 
        }

        showScreen('media-screen');
        setTimeout(() => { waitBtn.innerText = "Start Game"; waitBtn.disabled = false; waitBtn.onclick = () => enterMiniGame(); }, 3000);
    }

    function enterMiniGame() {
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateScore', email: currentUser.email, levelId: currentLevelId, stage: 'start' }) });
        currentUser.totalScore += 3;
        const cfg = levelsMap.get(currentLevelId);
        const gameType = cfg.gameType || 'memory';
        document.getElementById('memory-board').style.display = 'none'; document.getElementById('puzzle-board').style.display = 'none'; document.getElementById('mini-next-btn').disabled = true;
        if(gameType === 'puzzle') setupPuzzle(); else setupMemory();
        showScreen('minigame-screen');
    }

    function setupMemory() {
        const board = document.getElementById('memory-board');
        board.style.display = 'grid'; board.innerHTML = '';
        let matches = 0; let flipped = [];
        const assets = ['tube.png', 'molar.png', 'broken-tooth.png', 'tooth.png'];
        const cards = [...assets, ...assets].sort(() => Math.random() - 0.5);

        cards.forEach((filename) => {
            const card = document.createElement('div');
            card.className = 'memory-card'; 
            card.innerHTML = `<img src="assets/${filename}" alt="Icon">`;
            card.onclick = () => {
                if(flipped.length < 2 && !card.classList.contains('flipped')) {
                    card.classList.add('flipped'); flipped.push({card, val: filename});
                    if(flipped.length === 2) {
                        if(flipped[0].val === flipped[1].val) {
                            matches++; flipped = [];
                            if(matches === 4) document.getElementById('mini-next-btn').disabled = false;
                        } else {
                            setTimeout(() => { flipped.forEach(f => { f.card.classList.remove('flipped'); }); flipped = []; }, 800);
                        }
                    }
                }
            };
            board.appendChild(card);
        });
    }

    let draggedPiece = null;
    let touchOffsetX = 0;
    let touchOffsetY = 0;

    function setupPuzzle() {
        const board = document.getElementById('puzzle-board');
        board.style.display = 'block';
        const container = document.getElementById('p-pieces'); container.innerHTML = '';
        
        document.querySelectorAll('.drop-zone').forEach(dz => {
            dz.innerHTML = '';
            dz.ondragover = e => e.preventDefault();
            dz.ondrop = e => handleDrop(e, dz);
        });
        
        const pieces = [1, 2, 3, 4];
        pieces.sort(()=>Math.random()-.5).forEach(i => {
            const p = document.createElement('div');
            p.className = 'puzzle-piece-thumb';
            p.innerHTML = `<img src="assets/${i}.png" draggable="false">`; 
            p.dataset.id = i;
            p.draggable = true;
            p.ondragstart = (e) => e.dataTransfer.setData('text', i);
            p.addEventListener('touchstart', handleTouchStart, {passive: false});
            p.addEventListener('touchmove', handleTouchMove, {passive: false});
            p.addEventListener('touchend', handleTouchEnd);
            container.appendChild(p);
        });
    }

    function handleTouchStart(e) {
        e.preventDefault();
        draggedPiece = e.target.closest('.puzzle-piece-thumb');
        if(!draggedPiece) return;
        const touch = e.touches[0];
        const rect = draggedPiece.getBoundingClientRect();
        touchOffsetX = touch.clientX - rect.left;
        touchOffsetY = touch.clientY - rect.top;
        draggedPiece.style.position = 'fixed'; draggedPiece.style.zIndex = 1000;
        document.body.append(draggedPiece); 
        moveAt(touch.clientX, touch.clientY);
    }
    function handleTouchMove(e) { e.preventDefault(); if (!draggedPiece) return; moveAt(e.touches[0].clientX, e.touches[0].clientY); }
    function moveAt(x, y) { if(draggedPiece) { draggedPiece.style.left = x - touchOffsetX + 'px'; draggedPiece.style.top = y - touchOffsetY + 'px'; } }
    function handleTouchEnd(e) {
        if (!draggedPiece) return;
        draggedPiece.style.display = 'none'; 
        let elemBelow = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        draggedPiece.style.display = 'flex'; 
        let slot = elemBelow ? elemBelow.closest('.drop-zone') : null;
        const id = draggedPiece.dataset.id;
        if (slot && slot.dataset.s == id) {
            slot.innerHTML = `<img src="assets/${id}.png" class="puzzle-piece-placed piece-${id}-pos">`;
            draggedPiece.remove(); checkPuzzleWin();
        } else {
            draggedPiece.style.position = 'static'; draggedPiece.style.zIndex = 'auto';
            document.getElementById('p-pieces').appendChild(draggedPiece);
        }
        draggedPiece = null;
    }

    function handleDrop(e, dz) { 
        const id = e.dataTransfer.getData('text');
        if(dz.dataset.s == id) { 
            dz.innerHTML = `<img src="assets/${id}.png" class="puzzle-piece-placed piece-${id}-pos">`;
            const originals = document.querySelectorAll('.puzzle-piece-thumb');
            originals.forEach(p => { if(p.dataset.id == id) p.remove(); });
            checkPuzzleWin(); 
        } 
    }
    function checkPuzzleWin() { if(Array.from(document.querySelectorAll('.drop-zone')).every(s => s.hasChildNodes())) document.getElementById('mini-next-btn').disabled = false; }

    function finishMiniGame(btn) {
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        toggleBtnLoading(btn, true);
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateScore', email: currentUser.email, levelId: currentLevelId, stage: 'minigame' }) })
        .then(() => {
            toggleBtnLoading(btn, false);
            currentUser.totalScore += 4;
            startQuiz();
        });
    }

    function startQuiz() {
        const cfg = levelsMap.get(currentLevelId);
        document.getElementById('q-text').innerText = cfg.question;
        const optCon = document.getElementById('q-options'); optCon.innerHTML = '';
        cfg.options.forEach((opt, idx) => {
            const btn = document.createElement('div'); btn.className = 'quiz-opt'; btn.innerText = opt;
            btn.onclick = function() { document.querySelectorAll('.quiz-opt').forEach(b => b.classList.remove('selected')); this.classList.add('selected'); submitAnswer(idx + 1); };
            optCon.appendChild(btn);
        });
        showScreen('quiz-screen');
    }

    function submitAnswer(selectedIdx) {
        document.querySelectorAll('.quiz-opt').forEach(o => o.style.pointerEvents = 'none');
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateScore', email: currentUser.email, levelId: currentLevelId, stage: 'finish', selectedOption: selectedIdx }) })
        .then(r => r.json()).then(d => {
            currentUser.totalScore = d.totalScore; currentUser.levels = d.levels;
            const pts = d.isCorrect ? 10 : 7;
            document.getElementById('final-score').innerText = pts;
            if(d.isCorrect) confetti();
            showScreen('done-screen');
            renderHome();
        });
    }
</script>
</body>
</html>