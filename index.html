<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Riddles</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* Updated Color Palette based on the image */
    :root { 
        --primary: #0056b3; /* Dark blue from the right side of the gradient */
        --bg-light: #cce5ff; /* Light blue from the left side */
        --bg-dark: #004a99;  /* A slightly darker blue for gradients */
        --surface: #ffffff; 
        --text: #2D3436;
        --text-light: #ffffff; /* White text for dark backgrounds */
    }
    body { 
        font-family: 'Segoe UI', sans-serif; 
        /* New blue gradient background */
        background: linear-gradient(to right, var(--bg-light), var(--primary)); 
        margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: var(--text); -webkit-tap-highlight-color: transparent; 
    }
    .app-container { width: 100%; max-width: 480px; background: var(--surface); height: 100vh; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
    .screen { display: none; padding: 25px; flex-grow: 1; flex-direction: column; justify-content: center; overflow-y: auto; animation: fadeIn 0.3s ease; }
    .screen.active { display: flex; }
    #home-screen { justify-content: flex-start; padding: 0; }
    
    /* Auth Styling */
    .auth-box { text-align: center; width: 100%; }
    /* Title and paragraph text on auth screens to white for contrast */
    .auth-box h1, .auth-box p { color: var(--text); }
    #login-screen .auth-box h1, #login-screen .auth-box p,
    #register-screen .auth-box h1, #register-screen .auth-box p,
    #start-screen .auth-box h1, #start-screen .auth-box p {
        color: var(--text);
    }

    input { width: 100%; padding: 16px; margin: 8px 0; border: 2px solid #f0f0f0; border-radius: 12px; font-size: 16px; outline: none; box-sizing: border-box; }
    input:focus { border-color: var(--primary); background: #fdfdff; }
    input:read-only { background-color: #f8f8f8; color: #888; cursor: not-allowed; }
    button { width: 100%; padding: 16px; margin-top: 20px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
    button:active { transform: scale(0.98); }
    .secondary-btn { background: transparent; color: var(--primary); border: 2px solid var(--primary); margin-top: 10px; }
    
    /* Header & Score */
    .header { 
        /* Updated header gradient */
        background: linear-gradient(135deg, var(--primary), var(--bg-dark)); 
        color: white; padding: 25px; border-radius: 0 0 30px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 20px rgba(0, 86, 179, 0.2); 
    }
    .score-badge { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-weight: bold; display: flex; gap: 8px; align-items: center; }

    /* Level Grid */
    .level-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 20px; padding-bottom: 80px; }
    .level-card { aspect-ratio: 1; background: white; border-radius: 18px; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; border: 2px solid transparent; overflow: hidden; }
    .level-card.open { cursor: pointer; border-color: var(--bg-light); color: var(--primary); }
    .level-card.locked { opacity: 0.4; background: #eee; pointer-events: none; }
    .level-card.locked::after { content: '\f023'; font-family: "Font Awesome 6 Free"; position: absolute; font-size: 12px; color: var(--primary); bottom: 8px; }
    
    .level-card.completed { background: #eafff0; border-color: #2ecc71; color: #2ecc71; position: relative; }
    .completed-badge {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) rotate(-15deg);
        background: #2ecc71; color: white;
        padding: 4px 8px; border-radius: 6px;
        font-size: 10px; font-weight: 900;
        text-transform: uppercase;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        pointer-events: none;
    }

    /* Dialogs & Loaders */
    .dialog-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 200; backdrop-filter: blur(4px); animation: fadeIn 0.2s; }
    .dialog-box { background: white; width: 80%; max-width: 300px; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .dialog-icon { font-size: 40px; margin-bottom: 15px; display: block; color: var(--primary); }
    .dialog-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }

    .loader-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(2px); }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

<div class="app-container">
    <div id="loader" class="loader-overlay"><div class="spinner"></div></div>

    <div id="custom-dialog" class="dialog-overlay">
        <div class="dialog-box">
            <span id="dialog-icon" class="dialog-icon">ðŸŽ‰</span>
            <div id="dialog-title" style="font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #333;">Title</div>
            <div id="dialog-msg" style="color: #666; margin-bottom: 20px; font-size: 15px;">Message</div>
            <button class="dialog-btn" onclick="closeDialog()">OK</button>
        </div>
    </div>

    <div id="login-screen" class="screen active">
        <div class="auth-box">
            <h1 style="margin-bottom: 10px;">ðŸŽ® Game App</h1>
            <p style="margin-bottom: 25px;">Enter email to start</p>
            <input type="email" id="login-email" placeholder="Email Address">
            <button onclick="login()">Start Playing</button>
        </div>
    </div>

    <div id="register-screen" class="screen">
        <div class="auth-box">
            <h1>New Player</h1>
            <p style="font-size: 14px; margin-bottom: 15px;">Complete your profile to join the game!</p>
            <input type="text" id="reg-name" placeholder="Full Name">
            <input type="tel" id="reg-phone" placeholder="Phone Number">
            <input type="email" id="reg-email" placeholder="Email" readonly>
            <button onclick="register()">Create & Play</button>
            <button class="secondary-btn" onclick="showScreen('login-screen')">Cancel</button>
        </div>
    </div>

    <div id="home-screen" class="screen">
        <div class="header">
            <div><div style="font-size: 13px; opacity: 0.9;">Welcome,</div><div id="display-name" style="font-size: 20px; font-weight: 700;">Player</div></div>
            <div class="score-badge"><i class="fas fa-star" style="color: #ffd700"></i><span id="display-score">0</span></div>
        </div>
        <div class="level-grid" id="level-grid"></div>
        <button onclick="logout()" class="secondary-btn" style="width: 90%; margin: 20px auto;">Logout</button>
    </div>

    <div id="start-screen" class="screen">
        <div class="auth-box">
            <h1 id="level-title">Level X</h1>
            <div style="font-size: 60px; margin: 30px 0;">ðŸš€</div>
            <button onclick="instantStartLevel()">Start Game (+3 pts)</button>
            <button class="secondary-btn" onclick="showScreen('home-screen')">Back</button>
        </div>
    </div>

    <div id="quiz-screen" class="screen">
        <div id="q-text" style="font-size: 22px; text-align: center; margin-bottom: 30px; font-weight: 600;">Loading...</div>
        <div id="q-options" style="width: 100%;"></div>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbytYCxHssnHE1fKPcA1rUxIIFJlYXTED3O6nrT-9A1SXbq4iidpOWDWSqCMC2O-W6hb/exec'; 

    let currentUser = null;
    let gameConfig = [];
    let currentLevelId = 0;
    let dialogCallback = null;

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    
    function toggleLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

    function showDialog(title, msg, icon = 'â„¹ï¸', callback = null) {
        document.getElementById('dialog-title').innerText = title;
        document.getElementById('dialog-msg').innerText = msg;
        document.getElementById('dialog-icon').innerText = icon;
        document.getElementById('custom-dialog').style.display = 'flex';
        dialogCallback = callback;
    }

    function closeDialog() {
        document.getElementById('custom-dialog').style.display = 'none';
        if (dialogCallback) { dialogCallback(); dialogCallback = null; }
    }

    // --- LOGIC: AUTOMATIC REDIRECT ---
    function login() {
        const email = document.getElementById('login-email').value.trim();
        if(!email) return showDialog("Wait!", "Please enter your email address", "âš ï¸");
        
        toggleLoader(true);
        fetch(API_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'login', email }) 
        })
        .then(r => r.json())
        .then(data => {
            toggleLoader(false);
            if(data.status === 'success') { 
                currentUser = data.user; 
                gameConfig = data.gameConfig; 
                initHome(); 
            } 
            else if (data.message && (data.message.toLowerCase().includes("not found") || data.message.toLowerCase().includes("not registered"))) {
                // REDIRECT TO REGISTER
                document.getElementById('reg-email').value = email;
                showScreen('register-screen');
                showDialog("Welcome!", "We didn't find your account. Let's create one!", "ðŸ‘‹");
            }
            else {
                showDialog("Oops!", data.message, "âŒ");
            }
        })
        .catch(() => { 
            toggleLoader(false); 
            showDialog("Error", "Check your connection", "ðŸ“¡"); 
        });
    }

    function register() {
        const name = document.getElementById('reg-name').value.trim();
        const phone = document.getElementById('reg-phone').value.trim();
        const email = document.getElementById('reg-email').value.trim();

        if(!name || !phone) return showDialog("Missing Info", "Name and Phone are required", "ðŸ“");

        toggleLoader(true);
        fetch(API_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'register', name, phone, email }) 
        })
        .then(r => r.json())
        .then(resp => {
            toggleLoader(false);
            if(resp.status === 'success') { 
                currentUser = resp.user; 
                gameConfig = resp.gameConfig; 
                initHome(); 
            } else {
                showDialog("Error", resp.message, "âš ï¸");
            }
        })
        .catch(() => {
            toggleLoader(false);
            showDialog("Error", "Registration failed", "ðŸ“¡");
        });
    }

    function initHome() {
        document.getElementById('display-name').innerText = currentUser.name;
        document.getElementById('display-score').innerText = currentUser.totalScore;
        const grid = document.getElementById('level-grid');
        grid.innerHTML = '';
        for(let i=0; i<20; i++) {
            const levelNum = i + 1;
            const config = gameConfig[i] || { isActive: false };
            const userLevelData = currentUser.levels[levelNum];
            const isCompleted = userLevelData && userLevelData.status === 'completed';
            const card = document.createElement('div');
            card.className = 'level-card'; 
            card.innerText = levelNum;
            
            if (isCompleted) { 
                card.classList.add('completed'); 
                card.innerHTML += `<div class="completed-badge">COMPLETE</div>`;
                card.onclick = () => showDialog("Level " + levelNum, `Completed! Score: ${userLevelData.score}`, "ðŸ†"); 
            } 
            else if (config.isActive) { 
                card.classList.add('open'); 
                card.onclick = () => preloadLevel(levelNum); 
            } 
            else { card.classList.add('locked'); }
            grid.appendChild(card);
        }
        showScreen('home-screen');
    }

    function preloadLevel(id) { currentLevelId = id; document.getElementById('level-title').innerText = `Level ${id}`; showScreen('start-screen'); }

    function instantStartLevel() {
        if (!currentUser.levels[currentLevelId]) { 
            currentUser.levels[currentLevelId] = { status: 'started', score: 3 }; 
            currentUser.totalScore += 3; 
        }
        const qData = gameConfig[currentLevelId - 1];
        document.getElementById('q-text').innerText = qData.question;
        const optContainer = document.getElementById('q-options'); optContainer.innerHTML = '';
        qData.options.forEach((opt, idx) => {
            const btn = document.createElement('button'); btn.className = 'option-btn'; btn.innerText = opt;
            btn.onclick = () => handleAnswer(idx + 1, btn); optContainer.appendChild(btn);
        });
        showScreen('quiz-screen');
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateScore', email: currentUser.email, levelId: currentLevelId, stage: 'start' }) });
    }

    function handleAnswer(selectedIdx, btnElement) {
        const allBtns = document.querySelectorAll('.option-btn'); allBtns.forEach(b => { b.disabled = true; b.style.opacity = 0.5; });
        btnElement.style.opacity = 1; btnElement.innerText += " (Checking...)";
        
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateScore', email: currentUser.email, levelId: currentLevelId, stage: 'finish', selectedOption: selectedIdx }) })
        .then(r => r.json()).then(d => {
            currentUser.totalScore = d.totalScore; currentUser.levels = d.levels;
            if(d.isCorrect) {
                btnElement.style.background = '#2ecc71'; btnElement.style.color = 'white'; 
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                showDialog("Correct!", "+7 Points added!", "ðŸŽ‰", () => initHome());
            } else {
                btnElement.style.background = '#e74c3c'; btnElement.style.color = 'white';
                showDialog("Try Next Time", "+4 Points added.", "ðŸ˜”", () => initHome());
            }
        });
    }

    function logout() { currentUser = null; showScreen('login-screen'); }
</script>
</body>
</html>