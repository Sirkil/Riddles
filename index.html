<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Sensodyne Ramadan Riddles</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
 <style>
    /* --- FONT FACE --- */
    @font-face {
        font-family: 'Gilroy';
        src: url('assets/Gilroy-ExtraBold.ttf') format('opentype'),
             url('assets/Gilroy-Light.ttf') format('opentype');
        font-weight: normal;
        font-style: normal;
    }

    /* --- CONFIGURATION --- */
    :root {
        --primary: #0070c0;   
        --dark-blue: #003366; 
        --accent: #00d2ff;    
        --text-color: #ffffff;
        
        --bg-image: url('assets/background.png'); 
        --logo-image: url('assets/Sensodyne Ramadan Logo.png'); 
        --header-pattern: url('assets/top_pattern.png'); 
        --star-icon: url('assets/star_icon.png'); 
        --done-icon: url('assets/done_icon.png'); 
        --claim-stamp: url('assets/claim_stamp.png');
    }

    /* --- GLOBAL STYLES --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'Gilroy', 'Segoe UI', Tahoma, sans-serif;
        background: var(--dark-blue) var(--bg-image) no-repeat center center fixed;
        background-size: cover;
        margin: 0; padding: 0;
        color: var(--text-color);
        height: 100dvh;
        width: 100vw;
        overflow: hidden;
        display: flex;
        justify-content: center;
        overscroll-behavior: none; 
        user-select: none; 
    }

    .app-container {
        width: 100%; max-width: 450px;
        height: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding-top: env(safe-area-inset-top);
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .app-container::-webkit-scrollbar { display: none; }

    .screen {
        display: none;
        flex-direction: column;
        align-items: center;
        width: 100%;
        flex: 1; 
        padding: 20px;
        animation: fadeIn 0.4s ease-in-out;
        position: relative;
        z-index: 5; 
    }

    .screen.active { display: flex; }

    /* --- HOME SCREEN SPECIFIC LAYOUT (80/20 SPLIT) --- */
    #home-screen {
        height: 100%;
        padding: 0 !important; /* Remove default padding to control layout manually */
        justify-content: flex-start;
    }

    .home-content-wrapper {
        height: 80%;
        width: 100%;
        overflow-y: auto;
        padding: 20px; /* Re-apply padding here */
        display: flex;
        flex-direction: column;
        align-items: center;
        scrollbar-width: none;
    }
    .home-content-wrapper::-webkit-scrollbar { display: none; }

    .stamp-footer-area {
        height: 20%;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        z-index: 10;
        padding-bottom: 10px;
    }

    /* Dedicated stamp for the home screen (Not overlay) */
    .static-home-stamp {
        width: 100%;
        height: 90%;
        max-height: 140px;
        background: var(--claim-stamp img) no-repeat center;
        background-size: contain;
    }

    /* --- FOOTER --- */
    .app-footer {
        width: 100%;
        padding: 15px 25px;
        text-align: center;
        background: linear-gradient(to bottom, var(--dark-blue), #00224400);
        color: rgba(255, 255, 255, 1);
        font-size: 8px;
        font-weight: normal;
        letter-spacing: 0.5px;
        flex-shrink: 0; 
        border-top: 1px solid rgba(255, 255, 255, 0.25);
        padding-bottom: calc(15px + env(safe-area-inset-bottom)); 
        direction: rtl; 
        box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        transition: display 0.2s; 
    }

    /* --- GLOBAL STAMP (For Login/Register Overlay) --- */
.claim-stamp {
        position: absolute;
        bottom: 20px; 
        left: 50%; 
        transform: translateX(-50%);
        width: 100%; /* Changed to allow full width for two images */
        height: auto;
        z-index: 1; 
        pointer-events: none; 
        display: none; 
        opacity: 1;
        transition: width 0.3s ease, height 0.3s ease; 
        text-align: center; /* Centers the images */
        white-space: nowrap;
    }

    /* New rule for the images */
    .claim-stamp img {
        width: 35vw; 
        height: 35vw;
        max-width: 120px; 
        max-height: 120px;
        object-fit: contain;
        display: inline-block;
        margin: 0 5px; /* Adds small space between the two images */
    }

    /* --- UI ELEMENTS --- */
    .logo {
        width: 300px; height: 120px; 
        background: var(--logo-image) no-repeat center;
        background-size: contain;
        margin: 20px 0; flex-shrink: 0;
    }

    .input-group { 
        width: 85%; margin-bottom: 15px; 
        position: relative; z-index: 10; 
    }
    
    input {
        width: 100%;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.6);
        border-radius: 12px;
        padding: 14px 15px;
        color: white;
        font-family: 'Gilroy', sans-serif;
        font-size: 16px;
        outline: none; text-align: center;
        transition: 0.3s;
        appearance: none; 
    }
    input:focus { border-color: #fff; background: rgba(255,255,255,0.2); }
    input::placeholder { color: #e0e0e0; opacity: 1; }

    .btn {
        width: 85%; padding: 12px;
        background: linear-gradient(180deg, #0099cc 0%, #0056b3 100%);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 20px 0 20px 0;
        color: white; font-family: 'Gilroy', sans-serif;
        font-size: 18px; font-weight: bold; cursor: pointer;
        margin-top: 10px; transition: all 0.2s;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        display: flex; justify-content: center; align-items: center; gap: 10px;
        text-decoration: none;
        position: relative; z-index: 10; 
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled, .btn.disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; transform: none; pointer-events: none; }
    
    .btn-secondary { background: transparent; border: 1px solid rgba(255,255,255,0.5); margin-top: 10px; }
    
    .btn-icon-only {
        width: 50px; height: 50px;
        padding: 0; border-radius: 12px;
        display: flex; justify-content: center; align-items: center;
        font-size: 20px;
    }

    .link-text {
        color: #00d2ff; text-decoration: underline; cursor: pointer; margin-top: 15px; font-size: 14px;
        position: relative; z-index: 10;
    }

    /* --- NAVIGATION --- */
    .nav-header {
        width: 100%; display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 10px; padding: 0 5px; height: 50px; flex-shrink: 0;
    }
    .back-btn {
        background: rgba(255,255,255,0.2); border: none; color: white;
        width: 40px; height: 40px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; font-size: 18px;
    }

    /* --- TIMER --- */
    .timer-circle {
        width: 45px; height: 45px;
        background: #0070c0;
        border: 2px solid white;
        border-radius: 50%;
        color: white;
        display: flex; justify-content: center; align-items: center;
        font-weight: bold; font-size: 16px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    /* --- HEADER --- */
    .header-banner {
        width: 100%; height: 90px; 
        background: linear-gradient(180deg, #0056b3 0%, #0070c0 100%);
        border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        position: relative; margin-bottom: 20px; flex-shrink: 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); overflow: visible; z-index: 10;
    }
    .header-pattern {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background-image: var(--header-pattern);
        background-repeat: repeat; background-position: center; background-size: cover; 
        opacity: 0.5;
        border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        z-index: 1; pointer-events: none;
    }
    .header-content {
        position: relative; z-index: 2;
        display: flex; justify-content: space-between; align-items: center;
        height: 100%; padding: 0 25px; padding-top: 5px;
    }
    .user-info { flex: 1; text-align: left; }
    
    .logo-center {
        width: 140px; 
        height: 85px; 
        background: var(--logo-image) no-repeat center;
        background-size: contain; flex: 0 0 140px;
    }
    
    .score-container { flex: 1; display: flex; justify-content: flex-end; align-items: center;}
    .score-pill {
        background: rgba(0, 153, 204, 0.9);
        border: 1px solid rgba(255,255,255,0.5);
        border-radius: 20px; padding: 5px 12px;
        display: flex; align-items: center; gap: 6px;
        font-weight: bold; font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* --- HOME ACTIONS --- */
    .home-actions {
        display: flex; gap: 10px; width: 90%; justify-content: center;
        margin-top: 10px; margin-bottom: 40px;
        position: relative; z-index: 10;
    }

    /* --- LEVEL GRID --- */
    .level-grid {
        display: grid; grid-template-columns: repeat(4, 1fr);
        gap: 10px; width: 100%; padding: 0 5px 5px 5px; 
        position: relative; z-index: 10;
        height: 70%;
    }

    .level-btn {
        width: 85%;
        margin: 0 auto;
        aspect-ratio: 1;
        background: linear-gradient(135deg, #0070c0, #0056b3);
        border-radius: 16px;
        position: relative; 
        display: flex; 
        justify-content: center; 
        align-items: center;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
        cursor: pointer;
        border: 1px solid rgba(255,255,255,0.1);
        overflow: hidden;
    }
    
    .level-icon-img {
        position: absolute;
        width: 85%;  
        height: 85%;
        object-fit: contain;
        left: 5px;   
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;  
        opacity: 0.9;
    }

    .level-btn span {
        position: relative;
        z-index: 3;  
        font-size: 24px; 
        font-weight: 800;
        margin-left: 15px; 
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .level-btn.locked { opacity: 0.6; box-shadow: none; pointer-events: none;}
    .level-btn.completed { background: white; border: 2px solid #FFD700; color: #0070c0; }
    .star-img { width: 60%; height: 60%; background: var(--star-icon) no-repeat center; background-size: contain; }

    /* --- MEMORY GAME --- */
    .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 10px 0; width: 100%; }
    .memory-card { 
        background: #0070c0; aspect-ratio: 1; border-radius: 8px; 
        cursor: pointer; display:flex; justify-content:center; align-items:center; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .memory-card.flipped { background: white; border: 2px solid #0070c0; }
    .memory-card img { width: 80%; height: 80%; object-fit: contain; display: none; }
    .memory-card.flipped img { display: block; }

    /* --- CONTENT CARDS --- */
    .content-card {
        background: rgba(255,255,255,0.95); border-radius: 20px; padding: 20px; width: 95%;
        text-align: center; color: #333; margin-top: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .quiz-opt {
        background: white; border: none; color: #0070c0; 
        padding: 14px; border-radius: 16px 0 16px 0; width: 100%; margin-bottom: 10px;
        font-size: 15px; font-weight: bold; cursor: pointer;
        text-align: center; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex; justify-content: center; align-items: center;
        min-height: 50px; 
    }
    .quiz-opt:active, .quiz-opt.selected { background: #0070c0; color: white; transform: scale(0.98); }
    
    .quiz-question-box {
        background: linear-gradient(135deg, #002244, #0056b3); padding: 20px; border-radius: 16px; 
        margin-bottom: 20px; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .quiz-question-box h3 {
        margin: 0; text-align: center; font-weight: 600; line-height: 1.3;
        font-size: clamp(14px, 4vw, 18px); 
        word-wrap: break-word;
    }
    .detailer-trigger {
        width: 100%;
        text-align: right;
        margin-top: 10px;
    }
    .detailer-trigger span {
        font-size: 12px;
        color: #00d2ff;
        text-decoration: underline;
        cursor: pointer;
    }

    /* --- PDF SPECIFIC --- */
    .pdf-link-btn {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: #f0f0f0; border: 2px solid #0070c0; border-radius: 16px;
        padding: 15px; width: 100%; text-decoration: none; color: #0070c0;
        font-weight: bold; transition: 0.2s; margin: 15px 0; cursor: pointer;
    }
    .pdf-link-btn:active { background: #e0e0e0; transform: scale(0.98); }
    .pdf-icon-img { width: 40px; height: 40px; margin-bottom: 8px; object-fit: contain; }

    /* --- DONE SCREEN --- */
    .done-card {
        border: 1px solid rgba(255,255,255,0.5); border-radius: 20px; padding: 30px 20px; width: 90%;
        text-align: center; background: transparent; box-shadow: none;
    }
    .done-icon-large {
        width: 100px; height: 100px; background: var(--done-icon) no-repeat center; 
        background-size: contain; margin: 0 auto 15px auto;
    }
    
    /* --- DIALOGS --- */
    .dialog-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: none;
        justify-content: center; align-items: center; z-index: 999;
        backdrop-filter: blur(5px);
    }
    .dialog-box {
        background: linear-gradient(135deg, #0070c0, #004a99);
        width: 85%; padding: 25px; border-radius: 24px;
        text-align: center; border: 1px solid rgba(255,255,255,0.3);
        position: relative;
    }
    .close-dialog {
        position: absolute; top: 15px; right: 20px; 
        color: white; font-size: 24px; cursor: pointer;
    }
    .reward-item {
        background: rgba(255,255,255,0.1); margin: 8px 0; padding: 12px;
        border-radius: 12px; display: flex; align-items: center; gap: 12px;
        opacity: 0.5; transition: 0.3s; text-align: left;
    }
    .reward-item.unlocked { opacity: 1; background: rgba(255,255,255,0.2); border: 1px solid #FFD700; }
    .reward-icon { font-size: 22px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
 </style>
</head>
<body>

<div class="app-container">
    
    <div id="login-screen" class="screen active" style="justify-content: center;">
        <div class="logo"></div>
        <h3 style="margin-bottom:15px;">Welcome</h3>
        <div class="input-group"><input type="email" id="login-email" placeholder="Enter your Email"></div>
        <button class="btn" onclick="handleAuth(this)">Next</button>
    </div>

    <div id="register-screen" class="screen" style="justify-content: center; bottom: 30px;">
        <div class="logo"></div>
        <h3 style="margin:0 0 20px 0;">Complete Profile</h3>
        <div class="input-group"><input type="text" id="reg-name" placeholder="Full Name"></div>
        <div class="input-group"><input type="tel" id="reg-phone" placeholder="Phone Number"></div>
        <input type="hidden" id="reg-email-hidden"> 
        <button class="btn" onclick="handleRegister(this)">Start Playing</button>
        <div class="link-text" onclick="showScreen('login-screen')">Back</div>
    </div>

    <div id="home-screen" class="screen">
        <div class="home-content-wrapper">
            <div class="header-banner">
                <div class="header-pattern"></div>
                <div class="header-content">
                    <div class="user-info">
                        <div style="font-size:12px; opacity:0.8; margin-bottom:2px;">Hello!</div>
                        <div id="display-name" style="font-size:14px; font-weight:bold; line-height:1.1;">Player</div>
                    </div>
                    <div class="logo-center"></div>
                    <div class="score-container">
                        <div class="score-pill" onclick="openRewards()" style="cursor: pointer;">
                            <span>‚≠ê</span> <span id="display-score">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="level-grid" id="level-grid"></div>

            <div class="home-actions">
                <button class="btn" style="flex: 2; margin-top:0;" onclick="openRewards()">Giveaways</button>
                <button class="btn btn-secondary btn-icon-only" style="margin-top:0;" onclick="handleLogout()"><i class="fa fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="stamp-footer-area">
            <div class="static-home-stamp"></div>
        </div>
    </div>

    <div id="media-screen" class="screen">
        <div class="nav-header">
            <button class="back-btn" onclick="triggerExitAlert()"><i class="fa fa-arrow-left"></i></button>
            <div id="media-timer" class="timer-circle">60</div>
        </div>
        
        <div class="logo" style="transform:scale(0.8); margin-top:0; margin-bottom:10px;"></div>
        <div class="content-card">
            <div id="media-icon-container" style="margin-bottom:10px; display:flex; justify-content:center;"></div>
            <div id="media-content-area"></div>
        </div>
        
        <button id="media-next-btn" class="btn disabled" style="margin-top:auto; margin-bottom:20px;" disabled>
            Please Wait...
        </button>
    </div>

<div id="quiz-screen" class="screen" style="justify-content:center;">
        <div class="nav-header">
            <button class="back-btn" onclick="triggerExitAlert()"><i class="fa fa-arrow-left"></i></button>
            <div id="quiz-timer" class="timer-circle">60</div>
        </div>

        <div class="logo" style="transform:scale(0.6); margin-bottom:30px; margin-top:0;"></div>
        
        <img id="quiz-detailer-thumb" src="" 
             style="display:none; max-width: 250px; max-height: 250px; margin: 0 auto 15px auto; cursor: pointer; border-radius: 8px; border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 4px 10px rgba(0,0,0,0.2);" 
             onclick="triggerDetailer()" alt="Detailer Snapshot">

        <div class="quiz-question-box">
            <h3 id="q-text">Question?</h3>
            </div>
        <div id="q-options" style="width:100%;"></div>
    </div>

    <div id="minigame-screen" class="screen">
        <div class="nav-header">
            <button class="back-btn" onclick="triggerExitAlert()"><i class="fa fa-arrow-left"></i></button>
            <div id="memory-timer" class="timer-circle">60</div>
        </div>
        <div class="logo" style="transform:scale(0.7); margin:0 0;"></div>
        <h2 style="margin: 10px 0; font-size: 20px;">Memory Match</h2>
        
        <div id="memory-board" class="memory-grid"></div>
    </div>

    <div id="done-screen" class="screen" style="justify-content:center;">
        <div class="logo" style="margin-bottom:30px;"></div>
        <div class="done-card">
            <div class="done-icon-large"></div>
            <h1 class="done-text">DONE</h1>
            <p class="done-score">Total Score: <span id="final-score" style="font-weight:bold; color:white;"></span></p>
            <button class="btn" style="width:100%;" onclick="showScreen('home-screen')">OK</button>
        </div>
    </div>

    <div id="claim-stamp" class="claim-stamp">
        <img src="assets/claim_1.png" alt="Claim 1">
        <img src="assets/claim_2.png" alt="Claim 2">
    </div>

    <div class="app-footer">
        <Pm-Code>**</Pm-Code>
    </div>

</div>

<div id="rewards-dialog" class="dialog-overlay" onclick="closeRewards()">
    <div class="dialog-box" onclick="event.stopPropagation()">
        <span class="close-dialog" onclick="closeRewards()">&times;</span>
        <h2 style="margin-top:0; color:white;">Your Giveaways</h2>
        <div class="reward-item" id="rwd-1">
            <div class="reward-icon">üîí</div>
            <div><b>Giveaway</b><br><span style="font-size:12px;">Earn 200 points</span></div>
        </div>
    </div>
</div>

<div id="detailer-popup" class="dialog-overlay" onclick="closeDetailer()">
    <div class="dialog-box" onclick="event.stopPropagation()" style="width:95%; max-width:500px; padding:15px;">
        <span class="close-dialog" onclick="closeDetailer()" style="top:5px; right:10px;">&times;</span>
        <h3 style="margin-top:10px; color:white;">Detailer Snapshot</h3>
        <img id="detailer-img" src="" style="width:100%; height:auto; border-radius:10px; margin-top:5px;" alt="Detailer Info">
    </div>
</div>

<div id="exit-dialog" class="dialog-overlay">
    <div class="dialog-box" onclick="event.stopPropagation()">
        <h3 style="margin-top:0; color:white;">Exit Level?</h3>
        <p style="color:rgba(255,255,255,0.8); margin-bottom:25px;">Your progress for this level will be lost.</p>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="flex:1;" onclick="confirmExit()">Exit</button>
            <button class="btn btn-secondary" style="flex:1; margin-top:0;" onclick="closeExitAlert()">Cancel</button>
        </div>
    </div>
</div>

<div id="pdf-popup" class="dialog-overlay" onclick="closePdfPopup()">
    <div class="dialog-box" onclick="event.stopPropagation()" style="width:95%; height:85%; max-width:600px; padding:15px; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0; color:white;">Document</h3>
            <span style="font-size:28px; color:white; cursor:pointer; line-height:1;" onclick="closePdfPopup()">&times;</span>
        </div>
        <iframe id="pdf-frame" src="" style="width:100%; flex:1; border-radius:10px; border:none; background:white;"></iframe>
    </div>
</div>

<div id="custom-alert" class="dialog-overlay">
    <div class="dialog-box" onclick="event.stopPropagation()">
        <h3 id="alert-title" style="margin-top:0; color:white;">Alert</h3>
        <p id="alert-msg" style="color:rgba(255,255,255,0.9); margin-bottom:25px;"></p>
        <button class="btn" onclick="closeCustomAlert()">OK</button>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbxyAbNkAl7toIm4sGLSP9JBWtbyha4hiPy32crPLBeL3cTrlw5vmUWaSsWDOSxekqeQ/exec"; 

    // Updated: Added 'detailer' image paths for levels 9-16
 const LEVEL_CONFIG = [
        { id: 1, isActive: true, type: 'quiz', question: "Case:A 45-year-old male presents for routine cleaning. When asked, 'Do you have sensitive teeth?' he answers 'No.' Mild cervical abrasion is present. No prior use of desensitizing toothpaste.\nQuestion 2: According to the MEA DH algorithm, what is the next recommended step?", options: ["Begin desensitizing toothpaste immediately", "Administer the DHEQ-15 questionnaire", "Conduct a cold air blast test", "No further evaluation required"], correct: 3, unlockTime: 60, points: 10 },
        { id: 2, isActive: true, type: 'memory', unlockTime: 60, points: 10 },
        { id: 3, isActive: true, type: 'quiz', detailer: 'assets/detailer_13.png', question: "According to the content, DH negatively impacts patients' quality of life by:", options: ["Improving oral hygiene habits", "Affecting emotional, social, and functional aspects", "Increasing appetite", "Reducing dental visits"], correct: 2, unlockTime: 60, points: 10 },
        { id: 4, isActive: true, type: 'pdf', detailer: 'assets/detailer_8.png', media: 'https://riddles-1zcx.onrender.com/Sensodyne%20LB1%20_Rapid_EG_whatsapp%20FINAL.pdf', unlockTime: 60, question: "Percentages of Egyptians suffering from Dentine Hypersensitivity", options: ["30%", "50%", "64%", "10%"], correct: 3, points: 10 },
        { id: 5, isActive: true, type: 'audio', media: 'https://riddles-1zcx.onrender.com/aac_Decoding%20Dentine%20Discussions%20podcast%20series%20-%20Episode%201%20-%20Dr%20Manal%20Awad%20-%20Dentine%20Hypersensitivity%20Demystified.mp3', unlockTime: 420, points: 10 },
        { id: 6, isActive: true, type: 'quiz', detailer: 'assets/detailer_16.png', question: "DH tends to reoccur if:", options: ["The patient uses only water flossers", "Desensitizing agents are discontinued", "Fluoride toothpaste is used daily", "Patients consume hot beverages"], correct: 2, unlockTime: 60, points: 10 },
        { id: 7, isActive: true, type: 'quiz', detailer: 'assets/detailer_10.png', question: "What percentage of DH patients typically do NOT mention their condition to dentists?", options: ["10%", "25%", "50%", "75%"], correct: 3, unlockTime: 60, points: 10 },
        { id: 8, isActive: true, type: 'audio', media: 'https://riddles-1zcx.onrender.com/aac_Decoding%20Dentine%20Discussions%20podcast%20series%20-%20Episode%208%20-%20Dr%20Hesham%20Marei%20-%20The%20DH%20Challenge%20Myths%20and%20Realities.mp3', unlockTime: 420, points: 10 },
        { id: 9, isActive: true, type: 'quiz', detailer: 'assets/detailer_9.png', question: "According to MEA experts (2024), DH screening should be performed for:", options: ["Only high-risk patients", "Patients with visible enamel loss", "All patients visiting dental clinics", "Patients complaining of toothache"], correct: 3, unlockTime: 60, points: 10 },
        { id: 10, isActive: true, type: 'audio', media: 'https://riddles-1zcx.onrender.com/aac_Decoding%20Dentine%20Discussions%20podcast%20series%20-%20Episode%207%20-%20Dr%20Nour%20Habib%20-%20Winning%20A-Z%20Strategies%20for%20Managing%20DH.mp3', unlockTime: 420, points: 10 },
        { id: 11, isActive: true, type: 'quiz', detailer: 'assets/detailer_11.png', question: "The Schiff scale score '3' indicates:", options: ["Mild discomfort without request to stop", "No response to stimulus", "Patient requests discontinuation and considers stimulus painful", "Normal sensitivity"], correct: 3, unlockTime: 60, points: 10 },
        { id: 12, isActive: true, type: 'quiz', detailer: 'assets/detailer_12.png', question: "The first step in the MEA management algorithm for DH is:", options: ["Laser therapy", "Patient education & behavior modification", "Fluoride varnish", "Gingival grafting"], correct: 2, unlockTime: 60, points: 10 },
        { id: 13, isActive: true, type: 'pdf', detailer: 'assets/detailer_7.png', media: 'https://www.weebly.com/uploads/2/3/2/2/23222332/custom_themes/464933049751344157/files/sensodyne/Algorithm_V5RGY.pdf', unlockTime: 60, question: "Sensodyne Rapid action provides Dentine Hypersensitivity relief in", options: ["60 Seconds", "2 minutes", "1 hour", "2 days"], correct: 1, points: 10 },
        { id: 14, isActive: true, type: 'quiz', detailer: 'assets/detailer_14.png', question: "A key barrier preventing proper DH diagnosis is:", options: ["Excessive diagnostic time", "Overestimation of DH importance", "Lack of proactive screening", "High cost of diagnostic tools"], correct: 3, unlockTime: 60, points: 10 },
        { id: 15, isActive: true, type: 'quiz', detailer: 'assets/detailer_15.png', question: "For asymptomatic patients who answer 'NO' to sensitivity, the next step is:", options: ["Start immediate in-office treatment", "Use the DHEQ-15 questionnaire", "Perform cold air blast test", "No further evaluation"], correct: 3, unlockTime: 60, points: 10 },
        { id: 16, isActive: true, type: 'audio', media: 'https://riddles-1zcx.onrender.com/aac_Decoding%20Dentine%20Discussions%20podcast%20series%20-%20Episode%204%20-%20Dr%20Samira%20Osailan%2C%20Dr%20Aslan%20Gokbuget%20-%20Team%20Effort%20The%20Multidisciplinary%20Approach%20to%20DH.mp3', unlockTime: 420, points: 10 },
        { id: 17, isActive: true, type: 'quiz', question: "Case:A 32-year-old patient reports sharp, short pain when drinking cold water. She assumed it was normal and never mentioned it. Clinical exam shows no caries or fractures. Cold air blast test triggers immediate pain and she requests discontinuation.\nQuestion 1: Based on the Schiff scale, what score best represents her response?", options: ["No response", "Responds but does not request discontinuation", "Moves away or requests discontinuation", "Severe pain and immediate discontinuation"], correct: 4, unlockTime: 60, points: 10 },
        { id: 18, isActive: true, type: 'video', media: 'https://riddles-1zcx.onrender.com/1.mp4', unlockTime: 60, points: 10 },
        { id: 19, isActive: true, type: 'quiz', question: "Case:A 41‚Äëyear‚Äëold female patient reports discomfort when brushing and says she has begun avoiding brushing the cervical areas because ‚Äúthe pain is too sharp.‚Äù She has no active caries or fractures. She has never used a desensitizing toothpaste. A cold air blast test shows a clear response, but she does not request discontinuation of the stimulus.\nQuestion 3: Based on the MEA screening and diagnostic recommendations, what is the most appropriate next step for this patient?", options: ["Begin laser therapy immediately", "Start her on daily desensitizing toothpaste and provide behavior modification guidance", "Proceed directly to restorative treatment", "No treatment needed since symptoms are mild"], correct: 2, unlockTime: 60, points: 10 },
        { id: 20, isActive: true, type: 'video', media: 'https://riddles-1zcx.onrender.com/2.mp4', unlockTime: 60, points: 10 }
    ];

    // --- 2. APP STATE ---
    let currentUser = {
        name: "", email: "", phone: "", totalScore: 0, completedLevels: [] 
    };
    
    let currentLevelId = 0;
    let timerInterval = null;

    // --- 3. NAVIGATION & UI ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id !== 'media-screen' && timerInterval) clearInterval(timerInterval);

        // Footer & Stamp Logic
        const footer = document.querySelector('.app-footer');
        const globalStamp = document.getElementById('claim-stamp');
        const overlayStampScreens = ['login-screen', 'register-screen', 'home-screen'];
        
        if (overlayStampScreens.includes(id)) {
            if(footer) footer.style.display = 'none';
            if(globalStamp) {
                globalStamp.style.display = 'block';
                globalStamp.classList.remove('small-mode');
            }
        } 
        else if (id === 'home-screen') {
            if(footer) footer.style.display = 'none';
            if(globalStamp) globalStamp.style.display = 'none';
        } 
        else {
            if(footer) footer.style.display = 'block';
            if(globalStamp) globalStamp.style.display = 'none';
        }
    }

    // --- DIALOGS ---
    function showAlert(title, msg, callback) {
        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-msg').innerText = msg;
        const alertBox = document.getElementById('custom-alert');
        alertBox.style.display = 'flex';
        
        const btn = alertBox.querySelector('.btn');
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.onclick = () => {
            closeCustomAlert();
            if(callback) callback();
        };
    }
    
    function closeCustomAlert() {
        document.getElementById('custom-alert').style.display = 'none';
    }

    function triggerExitAlert() { document.getElementById('exit-dialog').style.display = 'flex'; }
    function closeExitAlert() { document.getElementById('exit-dialog').style.display = 'none'; }
    function confirmExit() { closeExitAlert(); showScreen('home-screen'); }
    function handleLogout() { if(confirm("Log out?")) location.reload(); }

    // --- DETAILER POPUP LOGIC ---
    function openDetailer(imgSrc) {
        document.getElementById('detailer-img').src = imgSrc;
        document.getElementById('detailer-popup').style.display = 'flex';
    }
    function closeDetailer() {
        document.getElementById('detailer-popup').style.display = 'none';
    }
    // --- PDF POPUP LOGIC ---
function openPdfPopup(pdfUrl) {
    // We use Google Docs Viewer to ensure it renders inside the iframe on all devices
    const viewerUrl = "https://docs.google.com/gview?embedded=true&url=" + encodeURIComponent(pdfUrl);
    document.getElementById('pdf-frame').src = viewerUrl;
    document.getElementById('pdf-popup').style.display = 'flex';
}

function closePdfPopup() {
    document.getElementById('pdf-popup').style.display = 'none';
    document.getElementById('pdf-frame').src = ""; // clear source to stop memory usage
}
    
    // Global variable to hold current detailer image logic if needed
    let currentDetailerImg = "";
    function triggerDetailer() {
        if(currentDetailerImg) openDetailer(currentDetailerImg);
    }

    // --- 4. BACKEND INTEGRATION ---
    function sendRequest(data, callback) {
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => callback(result))
        .catch(error => {
            showAlert("Error", "Connection lost. Please check internet.");
            const btns = document.querySelectorAll('.btn');
            btns.forEach(b => { if(b.innerText === "Loading...") b.innerText = "Try Again"; });
        });
    }

    // --- 5. AUTH LOGIC ---
    function handleAuth(btn) {
        const email = document.getElementById('login-email').value.trim();
        if(!email) return showAlert("Error", "Please enter your email.");

        btn.innerText = "Loading...";
        
        sendRequest({ action: 'login', email: email }, (res) => {
            if(res.status === 'success') {
                currentUser = res.user;
                renderHome();
                showScreen('home-screen');
                btn.innerText = "Next";
            } else if (res.status === 'not_found') {
                document.getElementById('reg-email-hidden').value = email; 
                showScreen('register-screen');
                btn.innerText = "Next";
            } else {
                showAlert("Error", res.message || "Something went wrong");
                btn.innerText = "Next";
            }
        });
    }

    function handleRegister(btn) {
        const name = document.getElementById('reg-name').value;
        const phone = document.getElementById('reg-phone').value;
        const email = document.getElementById('reg-email-hidden').value; 
        
        if(!name || !phone) return showAlert("Error", "Please fill all details.");
        
        btn.innerText = "Loading...";
        sendRequest({ action: 'register', name, email, phone }, (res) => {
            if(res.status === 'success') {
                currentUser = res.user;
                renderHome();
                showScreen('home-screen');
            } else {
                showAlert("Error", res.message);
            }
            btn.innerText = "Start Playing";
        });
    }

function renderHome() {
        document.getElementById('display-name').innerText = currentUser.name;
        document.getElementById('display-score').innerText = currentUser.totalScore;
        const grid = document.getElementById('level-grid'); 
        grid.innerHTML = '';

        LEVEL_CONFIG.forEach(lvl => {
            const div = document.createElement('div');
            const isDone = currentUser.completedLevels.includes(lvl.id);
            
            if (!lvl.isActive) {
                div.className = 'level-btn locked';
                div.innerHTML = `<span>${lvl.id}</span>`; 
            } else if (isDone) {
                div.className = 'level-btn completed';
                div.innerHTML = '<div class="star-img"></div>';
            } else {
                div.className = 'level-btn';
                div.innerHTML = `
                    <img src="assets/level_icon.png" class="level-icon-img" alt="icon">
                    <span>${lvl.id}</span>
                `;
                div.onclick = () => startLevel(lvl.id);
            }
            grid.appendChild(div);
        });
        
        updateRewardsUI();
    }

    // --- 7. GAME LOGIC ---
    function startLevel(id) {
        currentLevelId = id;
        const cfg = LEVEL_CONFIG.find(l => l.id === id);
        
        if (cfg.type === 'video' || cfg.type === 'audio' || cfg.type === 'pdf') {
            setupMediaScreen(cfg);
        } else if (cfg.type === 'quiz') {
            setupQuizScreen(cfg);
        } else if (cfg.type === 'memory') {
            setupMemoryGame(cfg); 
        }
    }

    function setupMediaScreen(cfg) {
        showScreen('media-screen'); // Call first

        const iconCon = document.getElementById('media-icon-container');
        const contentArea = document.getElementById('media-content-area');
        const btn = document.getElementById('media-next-btn');
        const timerDisplay = document.getElementById('media-timer');
        
        iconCon.innerHTML = ''; contentArea.innerHTML = '';
        btn.disabled = true; btn.classList.add('disabled');
        
        if(cfg.type === 'pdf') {
            contentArea.innerHTML = `
                <p>Read the document to complete the level.</p>
                <div class="pdf-link-btn" id="pdf-trigger">
                    <img src="assets/pdf_icon.png" class="pdf-icon-img" alt="PDF">
                    <span>Tap to View PDF</span>
                </div>
            `;
            btn.innerText = "Take Quiz";
        document.getElementById('pdf-trigger').onclick = () => {
        openPdfPopup(cfg.media); // Call our new popup function
        
        // Enable the "Take Quiz" button immediately after opening
        btn.disabled = false;
        btn.classList.remove('disabled');
    };
            btn.onclick = () => setupQuizScreen(cfg); 
        } 
        else {
            let iconClass = cfg.type === 'video' ? 'fa-video' : 'fa-headphones';
            iconCon.innerHTML = `<i class="fas ${iconClass}" style="font-size:50px; color:#0070c0;"></i>`;
            
            if(cfg.type === 'video') {
                contentArea.innerHTML = `
                    <video width="100%" height="200" controls autoplay style="border-radius:10px; background:black; max-width:100%;">
                        <source src="${cfg.media}" type="video/mp4">
                        Your browser does not support video.
                    </video>
                `;
            } else {
                 contentArea.innerHTML = `
                    <div style="margin-bottom:15px;">
                        <img src="assets/Sensodyne Ramadan Logo.png" style="width:120px; height:auto; opacity:0.9;">
                    </div>
                    <div style="background:#eee; padding:20px; border-radius:30px; margin-top:10px;">
                        <audio controls autoplay style="width:100%;">
                            <source src="${cfg.media}" type="audio/mpeg">
                            Your browser does not support audio.
                        </audio>
                    </div>`;
            }

            btn.innerText = "Finish Level";
            btn.onclick = () => completeLevel(cfg.points);
        }

        // TIMER LOGIC
        let timeLeft = cfg.unlockTime || 10;
        timerDisplay.innerText = timeLeft;
        if(timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.innerText = timeLeft;
            if(timeLeft <= 0) {
                if(cfg.type !== 'pdf') { 
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                }
                clearInterval(timerInterval);
            }
        }, 1000);
    }

    function setupQuizScreen(cfg) {
        showScreen('quiz-screen'); // FIX: Call BEFORE timer starts

        document.getElementById('q-text').innerText = cfg.question;
        const optCon = document.getElementById('q-options'); 
        optCon.innerHTML = '';
        
        // Detailer Button Logic
// Detailer Thumbnail Logic
        const thumb = document.getElementById('quiz-detailer-thumb');
        if(cfg.detailer) {
            currentDetailerImg = cfg.detailer;
            thumb.src = cfg.detailer;
            thumb.style.display = 'block';
        } else {
            currentDetailerImg = "";
            thumb.style.display = 'none';
        }

        let attempts = 0;

        cfg.options.forEach((opt, idx) => {
            const btn = document.createElement('div'); 
            btn.className = 'quiz-opt'; 
            btn.innerText = opt;
            btn.onclick = function() { 
                document.querySelectorAll('.quiz-opt').forEach(b => b.style.pointerEvents = 'none');
                
                document.querySelectorAll('.quiz-opt').forEach(b => b.classList.remove('selected')); 
                this.classList.add('selected'); 
                
                setTimeout(() => {
                    const isCorrect = (idx + 1) === cfg.correct;
                    
                    if(isCorrect) {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        completeLevel(10); 
                    } else {
                        attempts++;
                        if (attempts < 2) {
                            showAlert("Wrong Answer!", "You answered wrong. You have one more trial.", () => {
                                document.querySelectorAll('.quiz-opt').forEach(b => {
                                    b.classList.remove('selected');
                                    b.style.pointerEvents = 'auto';
                                });
                            });
                        } else {
                            showAlert("Wrong Answer!", "You earned 0 points for this level.", () => {
                               completeLevel(0); 
                            });
                        }
                    }
                }, 500);
            };
            optCon.appendChild(btn);
        });

        // Timer Display
        const timerDisplay = document.getElementById('quiz-timer');
        let timeLeft = cfg.unlockTime || 60;
        timerDisplay.innerText = timeLeft;
        
        if(timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                timerDisplay.innerText = timeLeft;
            } else {
                clearInterval(timerInterval);
            }
        }, 1000);
    }
    function setupMemoryGame(cfg) { 
        showScreen('minigame-screen'); // FIX: Call BEFORE timer starts

        const board = document.getElementById('memory-board');
        board.innerHTML = '';
        let matches = 0; let flipped = [];
        const assets = ['claim_1.png', 'claim_2.png', 'senso_logo.png', 'container.png']; 
        const cards = [...assets, ...assets].sort(() => Math.random() - 0.5);

        cards.forEach((filename) => {
            const card = document.createElement('div');
            card.className = 'memory-card'; 
            const imgHTML = `<img src="assets/${filename}" style="width:60%;">`;
            card.innerHTML = imgHTML;
            
            card.onclick = () => {
                if(flipped.length < 2 && !card.classList.contains('flipped')) {
                    card.classList.add('flipped'); 
                    flipped.push({card, val: filename});
                    if(flipped.length === 2) {
                        if(flipped[0].val === flipped[1].val) {
                            matches++; flipped = [];
                            if(matches === 4) {
                                setTimeout(() => { confetti(); completeLevel(10); }, 500); 
                            }
                        } else {
                            setTimeout(() => { flipped.forEach(f => { f.card.classList.remove('flipped'); }); flipped = []; }, 800);
                        }
                    }
                }
            };
            board.appendChild(card);
        });

        const timerDisplay = document.getElementById('memory-timer');
        let timeLeft = (cfg && cfg.unlockTime) ? cfg.unlockTime : 60;
        timerDisplay.innerText = timeLeft;
        
        if(timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                timerDisplay.innerText = timeLeft;
            } else {
                clearInterval(timerInterval);
            }
        }, 1000);
    }

    function completeLevel(pointsToAdd) {
        if(!currentUser.completedLevels.includes(currentLevelId)) {
            currentUser.completedLevels.push(currentLevelId);
            currentUser.totalScore += pointsToAdd; 
            
            sendRequest({
                action: 'saveProgress',
                email: currentUser.email,
                totalScore: currentUser.totalScore,
                completedLevels: currentUser.completedLevels
            }, (res) => { console.log("Progress Saved"); });
        }
        
        document.getElementById('final-score').innerText = currentUser.totalScore;
        showScreen('done-screen');
        renderHome(); 
    }

    function openRewards() { document.getElementById('rewards-dialog').style.display = 'flex'; }
    function closeRewards() { document.getElementById('rewards-dialog').style.display = 'none'; }
    function updateRewardsUI() {
        const s = currentUser.totalScore;
        if(s >= 200) {
            const item = document.getElementById('rwd-1');
            item.classList.add('unlocked');
            item.innerHTML = `
                <div class="reward-icon">üéâ</div>
                <div><b>Congratulations!</b><br><span style="font-size:12px;">Your score is 200 stay tuned for your recognition</span></div>
            `;
        }
    }

    // Initialize logic
    showScreen('login-screen');
</script>
</body>
</html>


